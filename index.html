<!DOCTYPE html>
<html>

<head>
	<title>Free Coin Portal</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
	<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="web3.js"></script>
	<script type="text/javascript">

		var contractAddress = '0x04Ec9a3b2a38d8661046456F7361dB2a0a30a8cA';
		var abi = [
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "addr",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "amount",
						"type": "uint256"
					}
				],
				"name": "addTokenAddress",
				"outputs": [],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "addr",
						"type": "address"
					}
				],
				"name": "claim",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"inputs": [],
				"name": "getAllTokens",
				"outputs": [
					{
						"internalType": "address[]",
						"name": "",
						"type": "address[]"
					},
					{
						"internalType": "uint256[]",
						"name": "",
						"type": "uint256[]"
					},
					{
						"internalType": "bytes32[]",
						"name": "",
						"type": "bytes32[]"
					},
					{
						"internalType": "bytes32[]",
						"name": "",
						"type": "bytes32[]"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "addr",
						"type": "address"
					}
				],
				"name": "getTokenInfo",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "",
						"type": "string"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "addr",
						"type": "address"
					}
				],
				"name": "getTokenOwner",
				"outputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "address",
						"name": "addr",
						"type": "address"
					}
				],
				"name": "getTokenSupply",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"stateMutability": "view",
				"type": "function"
			},
			{
				"inputs": [
					{
						"internalType": "string",
						"name": "source",
						"type": "string"
					}
				],
				"name": "stringToBytes32",
				"outputs": [
					{
						"internalType": "bytes32",
						"name": "result",
						"type": "bytes32"
					}
				],
				"stateMutability": "pure",
				"type": "function"
			}
		]

		var network = "";
		var userAccount = '';
		var warning = "";
	</script>
	<script type="text/javascript">
		window.addEventListener('load', function () {})

		function startApp() {
			web3.eth.net.getId().then(netId => {
				console.log('netId: ' + netId)
				switch (netId) {
					case 1:
						network = 'Mainnet';
						warning = 'please switch your network to Rinkeby';
						break
					case 2:
						network = 'Deprecated Morden';
						warning = 'please switch your network to Rinkeby';
						break
					case 3:
						network = 'Ropsten';
						warning = 'please switch your network to Rinkeby';
						break
					case 4:
						network = 'Rinkeby';
						break
					case 42:
						network = 'Kovan';
						warning = '';
						break
					default:
						network = 'Unknown';
						warning = 'please switch your network to Rinkeby';
				}

				web3.eth.getAccounts().then(accounts => {
					userAccount = accounts[0];
					$("#user_address").text(userAccount);
					reloadInfo();
					$('#connect_button').hide()
					$('#disconnect_button').show()
				})
			})
		}

		function reloadInfo() {
			try {
				let contract = new web3.eth.Contract(abi, contractAddress)
				getAllTokens()
			}
			catch (err) {
				console.log(err);
			}
		}

		function getAllTokens() {
			let contract = new web3.eth.Contract(abi, contractAddress);
			contract.methods.getAllTokens().call().then(result => {
				$.each(result[0], function (i, v) {
					$('#token_list_table').append('<tr><td class="table-label">' +
						web3.utils.hexToAscii(result[3][i]) + ' (' +
						web3.utils.hexToAscii(result[2][i]) + ') <a href="javascript:openContractOnEtherScan(\'' +
						result[0][i] + '\');" style="margin-left: 8px;">' +
						'<i class="fas fa-sm fa-external-link-alt"></i></a></td><td class="table-value">' +
						result[1][i] + '</td><td><a class="button is-rounded is-small is-dark" href="javascript:claim(\'' +
						result[0][i] + '\')">รับเหรียญ ' + web3.utils.hexToAscii(result[3][i]) + ' </a></td></tr>');
				});
			});
		}

		function claim(address) {
			if (web3 !== null && userAccount !== null) {
				console.log("claim for", address)
				let option = { from: userAccount }
				let contract = new web3.eth.Contract(abi, contractAddress)
				contract.methods.claim(address).send(option)
					.on('error', (error) => {
						console.error(error)
					})

					// Transaction already saved to mempool
					.on('transactionHash', (transactionHash) => {
						console.log(transactionHash)
					})

					// Transaction got confirmed
					.on('confirmation', (confirmationNumber, receipt) => {
						console.log('confirmationNumber', confirmationNumber)
						console.log(receipt);
					})
			}
		}


		function openContractOnEtherScan(address) {
			let url = 'https://' + network + '.etherscan.io/token/' + address
			window.open(url, '_blank');
		}

		function openAddressOnEtherScan(address) {
			let url = 'https://' + network + '.etherscan.io/address/' + address
			window.open(url, '_blank');
		}

		function connect(params) {
			if (window.ethereum) {
				web3 = new Web3(ethereum);
				try {
					ethereum.enable().then(result => {
						startApp()
					})
				}
				catch (err) {
					console.log(err);
				}
			} else if (typeof web3 !== 'undefined') {
				web3 = new Web3(web3.currentProvider);
				startApp();
			}
		}

		function disconnect(params) {
			$('#token_list_table').empty()
			userAccount = null;
			$('#connect_button').show()
			$('#disconnect_button').hide()
		}
	</script>

	<style type="text/css">
		.p_network {
			border: 4px solid;
			border-radius: 10px;
			padding: 10px;
			border-color: #2196F3;
			text-align: center;
			width: 11em;
			margin: auto;
			margin-top: 20px;
		}

		.p_warning {
			padding: 10px;
			text-align: center;
			margin: auto;
			color: red;
		}

		.title {
			text-align: center;
			margin: auto;
			margin-top: 9px;
			margin-bottom: 20px;
		}

		table.info tr {
			line-height: 2em;
		}

		table.info .table-label {
			width: 10em;
			margin-right: 20px;
			font-weight: bold;
		}

		table.info .table-value {
			word-break: break-all;
			text-align: center;
		}

		table.info {
			width: 100%;
		}

		.table-title {
			font-size: 1.5rem;
		}

		.footer {
			bottom: 0;
			position: fixed;
			width: 100%;
		}
	</style>
</head>

<body>
	<section class="hero">
		<div class="hero-body">
			<div class="container">
				<h1 class="title">
					แจกเหรียญฟรี!
				</h1>
			</div>
		</div>
	</section>
	<section style="text-align: center;">
		<a id="connect_button" class="button is-rounded is-dark" href="javascript:connect()">เชื่อมต่อกระเป๋า</a><br>
		<div id="disconnect_button" style="display: none;">
			<span id="user_address" class="button is-static"></span>&nbsp;
			<a class="button is-rounded is-dark" href="javascript:disconnect()">หยุดเชื่อมต่อกระเป๋า</a>
		</div>
	</section>
	<p>&nbsp;</p>
	<div class="tile is-ancestor" style="max-width: 720px; margin-left: auto; margin-right: auto">
		<div class="tile is-parent">
			<article class="tile is-child box notification">
				<table class="info">
					<thead>
						<tr>
							<td width="200">เหรียญ</td>
							<td class="table-value">จำนวนเหรียญที่แจก</td>
							<td></td>
						</tr>
					</thead>
					<tbody id="token_list_table"></tbody>
				</table>
			</article>
		</div>
	</div>
	<footer class="footer">
		<div class="content has-text-centered">
			<p>
				developed by Crypto9
			</p>
		</div>
	</footer>
</body>

</html>